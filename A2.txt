#include "mbed.h"
#include "PID.h"
#include "QEI.h"
#include "C12832.h"

#define RATE 0.1

DigitalOut Enable(PB_6);
C12832 lcd(D11, D13, D12, D7, D10);

DigitalOut sensor1(PB_4);
DigitalOut sensor2(PB_5);
DigitalOut sensor3(PB_3);
DigitalOut sensor4(PA_10);
DigitalOut sensor5(PB_8);
DigitalOut sensor6(PB_9);

AnalogIn out1(PC_0);
AnalogIn out2(PC_1);
AnalogIn out3(PC_2);
AnalogIn out4(PC_3);
AnalogIn out5(PA_4);
AnalogIn out6(PB_0);


class Bipolar {
private:
    DigitalOut Bi;
public:
    Bipolar(PinName pin): Bi(pin) {}
    void tru(void) {Bi = 1 ;}
};

class On {
private:
    DigitalOut pins;
public:
    On(PinName pin): pins(pin) {}
    void tru(void) {pins = 1 ;}
};

class motors {
private:
    PwmOut Motor1;
    PwmOut Motor2;
public:
    motors(PinName l, PinName r) : Motor1(l), Motor2(r) {}
    void setperiod(){
        Motor1.period(0.0002f);
        Motor2.period(0.0002f);
        }
    void constant (){
        Motor1.write(0.95f);
        Motor2.write(0.95f);
        }
    void left () {
        Motor2.write(0.8f);
        Motor1.write(0.6f);
        }
    void right () {
        Motor2.write(0.6f);
        Motor1.write(0.8f);
        }
    void stop () {
        Motor1.write(0.5f);
        Motor2.write(0.5f);
        }  
};

/*class display {
private:
    float values, error, controlaction;
    int ref;
    float integral;
    float derivative;
    float kd;
    float ki;
    float kp;
    float lasterror;
public:
    display () {ref=0, integral=0, derivative=0, kd=0, ki=0,kp=1, lasterror=0;}
    float calculation(){
        values = (3.2)*out1.read()+(2.1)*out2.read()+1*out3.read()+(-1)*out4.read()+(-2)*out5.read()+(-3)*out6.read();
        error=ref-values;
        integral = integral + error;
        derivative = lasterror - error; //derivative=(lasterror - error)/dt ADD dt
        controlaction = (kp*error)+(ki*integral)+(kd*derivative);
        lasterror=error;
        return controlaction;
    }
 
    


}; 
*/
class control {
private:
    float values, error, controlaction;
    int ref;
    float integral;
    float derivative;
    float kd;
    float ki;
    float kp;
    float lasterror;
    PwmOut MotorOne,MotorTwo;
public:
    control (PinName l, PinName r) : MotorOne(l), MotorTwo(r) {ref=0, integral=0, derivative=0, kd=0, ki=0,kp=0.15, lasterror=0;}
    void setspeed(){
        values = (3.2)*out1.read()+(2.1)*out2.read()+1*out3.read()+(-1)*out4.read()+(-2)*out5.read()+(-3)*out6.read();
        error=ref-values;
        integral = integral + error;
        derivative = lasterror - error; //derivative=(lasterror - error)/dt ADD dt
        controlaction = (kp*error)+(ki*integral)+(kd*derivative);
        lasterror=error;
        MotorOne.write(0.6f - controlaction);
        MotorTwo.write(0.6f + controlaction);
        wait(0.001);
    }
    
    void setperiod(){
        MotorOne.period(0.0002f);
        MotorTwo.period(0.0002f);
    }
     
};  

/*class control : public motors {
private:
    float values;
    float co ;
    float power1,power2; 
public:
    control (PinName l, PinName r) : motors(l,r) {}
    void calculation(){
        values = out1.read()+out2.read()+out3.read()+out4.read()+out5.read()+out6.read();
        controller.setProcessValue(values);
        co= controller.compute() * 5;  //test this
        }
    void powers (){
        power1=power1+co;
        power2=power2-co;
    }
    
    float showvalue (void) {
        values =5*out1.read()+2.5*out2.read()+1.2*out3.read()+(-1.45)*out4.read()+(-2.4)*out5.read()+(-3.7)*out6.read()+0.855+0.29;
        return values;   
        
    }
    
    
    
    void tomotors (){
        if (values<(-0.2)){
            left();
        }  
        //else if ((sensor0.read()+sensor1.read()+sensor2.read())<(sensor3.read()+sensor4.read()+sensor5.read())){
                    //Motor2.write(power1); //left motor
                    //Motor1.write(power2); }
        else {  constant();
        }
    }
        
};*/

/*class Bluetooth : public motors  {
private:
    Ticker ok;
    char c;
    Serial hm10,hm11;
public:
    Bluetooth(PinName pin, PinName pin1) : hm10(pin), hm11(pin1) {ok.attach(callback(this, &Bluetooth::signal), 0.001);}
    void signal (void) {
        if(hm10.readable()){
            c = hm10.getc();
                if(c == 'A'){
                    turnaround();}
                }
        }
    void turnaround (void) {
        Motor2.write(0.5f);
        Motor1.write(0.5f);
        wait(1);
        Motor2.write(0.8f);
        Motor2.write(0.4f);
        }
};
*/

//display A;
Bipolar B1(PA_7);
Bipolar B2(PA_8);
//motors m(PB_10,PA_6);
control pidsensors(PB_10,PA_6);
//Bluetooth hm10(PA_11, PA_12);


int main(void) {
    //lcd.cls();
    //hm10.baud(9600);
    Enable = 0;
    B1.tru();
    B2.tru();
    sensor1=1;
    sensor2=1;
    sensor3=1;
    sensor4=1;
    sensor5=1;
    sensor6=1;
    pidsensors.setperiod();
    wait(3);
    Enable=1;
    while(1){
        pidsensors.setspeed();
    }
    
}